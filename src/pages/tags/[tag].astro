---
import { sanityClient } from 'sanity:client';
import BaseLayout from '../../layouts/BaseLayout.astro';
import StoryList from '../../components/StoryList.astro';

export async function getStaticPaths() {
  const stories = await sanityClient.fetch(`*[_type == "story" && !draft]`);
  const tagSet = new Set<string>();
  stories.forEach(story => {
    if (Array.isArray(story.tags)) {
      story.tags.forEach((tag: string) => tagSet.add(tag));
    }
  });
  return Array.from(tagSet).map(tag => ({ params: { tag } }));
}

const { tag } = Astro.params;
const stories = await sanityClient.fetch(`*[_type == "story" && !draft && $tag in tags]`, { tag });
---

<BaseLayout 
  title={`#${tag.toLowerCase()} | mostly true`}
  description={`Stories tagged with "${tag.toLowerCase()}" - explore related stories about ${tag.toLowerCase()} and more.`}
>
  <h1>stories tagged: <span class="tag">{tag.toLowerCase()}</span></h1>
  <hr/>
  <br/>
  <StoryList stories={stories} />
</BaseLayout> 